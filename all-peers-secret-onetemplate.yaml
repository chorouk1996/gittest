apiVersion: template.openshift.io/v1
kind: Template
labels:
  template: all-peers-secret-template
metadata:
  name: all-peers-secret-template
objects:
#################################
# ORG1 / PEER 0 (DC ; PVC ; Service)
#################################
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: peer0-bank1-secret-dc
  spec:
    strategy:
      type: Recreate
    replicas: 1
    template:
      metadata:
        labels:
          name: peer0
      spec:
        volumes:
          - name: fabricfiles
            persistentVolumeClaim:
              claimName: fabric-pvc
          - name: peer0file
            persistentVolumeClaim:
              claimName: peer0-pvc
          - name: secret-volume
            secret:
              secretName: secret-blockchain-org1-solution2
        containers:
          - name: peer0-bank1-banksco-com
            image: hyperledger/fabric-peer:2.2.0
            imagePullPolicy: Always
            command: ["sh","-c","peer node start"]
            env:
              - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT
                value: "peer0:7051"
              - name: CORE_PEER_GOSSIP_ORGLEADER
                value: "false"
              - name: CORE_PEER_GOSSIP_USELEADERELECTION
                value: "true"
              - name: CORE_PEER_ID
                value: "peer0"
              - name: FABRIC_LOGGING_SPEC
                value: "DEBUG"
              - name: CORE_PEER_LOCALMSPID
                value: "Bank1MSP"
              - name: CORE_PEER_MSPCONFIGPATH
                value: /fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/msp/
              - name: CORE_PEER_PROFILE_ENABLED
                value: "true"
              - name: CORE_PEER_TLS_ENABLED
                value: "true"                
              - name: CORE_PEER_TLS_CERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/server.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/server.crt"
                #    key: peerorg.orgdomain1.peers.peer0.tls.servercrt
              - name: CORE_PEER_TLS_KEY_FILE
                value: "/etc/secret-volume/peerorg.orgdomain1.peers.peer0.tls.serverkey"
                #value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/server.key"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/server.key"
                #    key: peerorg.orgdomain1.peers.peer0.tls.serverkey
              - name: CORE_PEER_TLS_ROOTCERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/ca.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer0.bank1.banksco.com/tls/ca.crt"
                #    key: peerorg.orgdomain1.peers.peer0.tls.cacrt
            volumeMounts:
              - name: fabricfiles
                mountPath: /fabric
              - name: peer0file
                mountPath: /var/hyperledger/production/
              - name: secret-volume
                mountPath: /etc/secret-volume
                readOnly: true
            ports:
              - containerPort: 7051
- apiVersion: v1
  kind: Service
  metadata:
    annotations: null
    labels: null
    name: peer0
  spec:
    ports:
    - name: "7051"
      port: 7051
      targetPort: 7051
    selector:
      name: peer0
- kind: PersistentVolumeClaim
  apiVersion: v1
  metadata:
    name: peer0-pvc
  spec:
    accessModes:
      #- ReadWriteOnce #CONFIG1 -> KO
      - ReadWriteMany #CONFIG2 -> OK
    resources:
      requests:
        storage: 1Gi
    #storageClassName: ibmc-block-retain-bronze #CONFIG1 -> KO
    storageClassName: ibmc-file-bronze #CONFIG2 -> OK

#################################
# ORG1 / PEER 1 (DC ; PVC ; Service)
#################################
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: peer1-bank1-secret-dc
  spec:
    strategy:
      type: Recreate
    replicas: 1
    template:
      metadata:
        labels:
          name: peer1
      spec:
        volumes:
        - name: fabricfiles
          persistentVolumeClaim:
            claimName: fabric-pvc
        - name: peer1file
          persistentVolumeClaim:
            claimName: peer1-pvc
        - name: secret-volume
          secret:
            secretName: secret-blockchain-org1-solution2
        containers:
          - name: peer1-bank1-banksco-com
            image: hyperledger/fabric-peer:2.2.0
            imagePullPolicy: Always
            command: ["sh","-c","peer node start"]
            env:
              - name: CCORE_PEER_GOSSIP_BOOTSTRAP
                value: "peer1:7051"
              - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT
                value: "peer1:7051"
              - name: CORE_PEER_GOSSIP_ORGLEADER
                value: "false"
              - name: CORE_PEER_GOSSIP_USELEADERELECTION
                value: "true"
              - name: CORE_PEER_ID
                value: "peer1"
              - name: FABRIC_LOGGING_SPEC
                value: "DEBUG"
              - name: CORE_PEER_LOCALMSPID
                value: "Bank1MSP"
              - name: CORE_PEER_MSPCONFIGPATH
                value: /fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/msp/                
              - name: CORE_PEER_PROFILE_ENABLED
                value: "true"
              - name: CORE_PEER_TLS_ENABLED
                value: "true"                
              - name: CORE_PEER_TLS_CERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/server.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/server.crt"
                #    key: peerorg.orgdomain1.peers.peer1.tls.servercrt
              - name: CORE_PEER_TLS_KEY_FILE
                value: "/etc/secret-volume/peerorg.orgdomain1.peers.peer1.tls.serverkey"
                #value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/server.key"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/server.key"
                #    key: peerorg.orgdomain1.peers.peer1.tls.serverkey
              - name: CORE_PEER_TLS_ROOTCERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/ca.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org1-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank1.banksco.com/peers/peer1.bank1.banksco.com/tls/ca.crt"
                #    key: peerorg.orgdomain1.peers.peer1.tls.cacrt
            volumeMounts:
              - name: fabricfiles
                mountPath: /fabric
              - name: peer1file
                mountPath: /var/hyperledger/production/
              - name: secret-volume
                mountPath: /etc/secret-volume
            ports:
              - containerPort: 7051
- apiVersion: v1
  kind: Service
  metadata:
    annotations: null
    labels: null
    name: peer1
  spec:
    ports:
    - name: "7051"
      port: 7051
      targetPort: 7051
    selector:
      name: peer1
- kind: PersistentVolumeClaim
  apiVersion: v1
  metadata:
    name: peer1-pvc
  spec:
    accessModes:
      #- ReadWriteOnce #CONFIG1 -> KO
      - ReadWriteMany #CONFIG2 -> OK
    resources:
      requests:
        storage: 1Gi
    #storageClassName: ibmc-block-retain-bronze #CONFIG1 -> KO
    storageClassName: ibmc-file-bronze #CONFIG2 -> OK

#################################
# ORG2 / PEER 2 (DC ; PVC ; Service)
#################################
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: peer2-bank2-secret-dc
  spec:
    strategy:
      type: Recreate
    replicas: 1
    template:
      metadata:
        labels:
          name: peer2
      spec:
        volumes:
        - name: fabricfiles
          persistentVolumeClaim:
            claimName: fabric-pvc
        - name: peer2file
          persistentVolumeClaim:
            claimName: peer2-pvc
        - name: secret-volume
          secret:
            secretName: secret-blockchain-org2-solution2
        containers:
          - name: peer2-bank2-banksco-com
            image: hyperledger/fabric-peer:2.2.0
            imagePullPolicy: Always
            command: ["sh","-c","peer node start"]
            env:
              - name: CORE_PEER_GOSSIP_BOOTSTRAP
                value: "peer2:7051"
              - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT
                value: "peer2:7051"
              - name: CORE_PEER_GOSSIP_ORGLEADER
                value: "false"
              - name: CORE_PEER_GOSSIP_USELEADERELECTION
                value: "true"
              - name: CORE_PEER_ID
                value: "peer2"
              - name: FABRIC_LOGGING_SPEC
                value: "DEBUG"
              - name: CORE_PEER_LOCALMSPID
                value: "Bank2MSP"
              - name: CORE_PEER_MSPCONFIGPATH
                value: /fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/msp/               
              - name: CORE_PEER_PROFILE_ENABLED
                value: "true"
              - name: CORE_PEER_TLS_ENABLED
                value: "true"                
              - name: CORE_PEER_TLS_CERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/server.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/server.crt"
                #    key: peerorg.orgdomain2.peers.peer2.tls.servercrt
              - name: CORE_PEER_TLS_KEY_FILE
                value: "/etc/secret-volume/peerorg.orgdomain2.peers.peer2.tls.serverkey"
                #value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/server.key"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/server.key"
                #    key: peerorg.orgdomain2.peers.peer2.tls.serverkey
              - name: CORE_PEER_TLS_ROOTCERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/ca.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer2.bank2.banksco.com/tls/ca.crt"
                #    key: peerorg.orgdomain2.peers.peer2.tls.cacrt
            volumeMounts:
              - name: fabricfiles
                mountPath: /fabric
              - name: peer2file
                mountPath: /var/hyperledger/production/
              - name: secret-volume
                mountPath: /etc/secret-volume
            ports:
              - containerPort: 7051
- apiVersion: v1
  kind: Service
  metadata:
    annotations: null
    labels: null
    name: peer2
  spec:
    ports:
    - name: "7051"
      port: 7051
      targetPort: 7051
    selector:
      name: peer2
- kind: PersistentVolumeClaim
  apiVersion: v1
  metadata:
    name: peer2-pvc
  spec:
    accessModes:
      #- ReadWriteOnce #CONFIG1 -> KO
      - ReadWriteMany #CONFIG2 -> OK
    resources:
      requests:
        storage: 1Gi
    #storageClassName: ibmc-block-retain-bronze #CONFIG1 -> KO
    storageClassName: ibmc-file-bronze #CONFIG2 -> OK

#################################
# ORG2 / PEER 3 (DC ; PVC ; Service)
#################################
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: peer3-bank2-secret-dc
  spec:
    strategy:
      type: Recreate
    replicas: 1
    template:
      metadata:
        labels:
          name: peer3
      spec:
        volumes:
        - name: fabricfiles
          persistentVolumeClaim:
            claimName: fabric-pvc
        - name: peer3file
          persistentVolumeClaim:
            claimName: peer3-pvc
        - name: secret-volume
          secret:
            secretName: secret-blockchain-org2-solution2
        containers:
          - name: peer3-bank2-banksco-com
            image: hyperledger/fabric-peer:2.2.0
            imagePullPolicy: Always
            command: ["sh","-c","peer node start"]
            env:
              - name: CORE_PEER_GOSSIP_BOOTSTRAP
                value: "peer3:7051"
              - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT
                value: "peer3:7051"
              - name: CORE_PEER_GOSSIP_ORGLEADER
                value: "false"
              - name: CORE_PEER_GOSSIP_USELEADERELECTION
                value: "true"
              - name: CORE_PEER_ID
                value: "peer3"
              - name: FABRIC_LOGGING_SPEC
                value: "DEBUG"
              - name: CORE_PEER_LOCALMSPID
                value: "Bank2MSP"
              - name: CORE_PEER_MSPCONFIGPATH
                value: /fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/msp/              
              - name: CORE_PEER_PROFILE_ENABLED
                value: "true"
              - name: CORE_PEER_TLS_ENABLED
                value: "true" 
              - name: CORE_PEER_TLS_CERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/server.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/server.crt"
                #    key: peerorg.orgdomain2.peers.peer3.tls.servercrt
              - name: CORE_PEER_TLS_KEY_FILE
                value: "/etc/secret-volume/peerorg.orgdomain2.peers.peer3.tls.serverkey"
                #value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/server.key"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/server.key"
                #    key: peerorg.orgdomain2.peers.peer3.tls.serverkey
              - name: CORE_PEER_TLS_ROOTCERT_FILE
                value: "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/ca.crt"
                #valueFrom:
                #  secretKeyRef:
                #    name: secret-blockchain-org2-solution2
                #    #corresponding file location : "/fabric/crypto-config/peerOrganizations/bank2.banksco.com/peers/peer3.bank2.banksco.com/tls/ca.crt"
                #    key: peerorg.orgdomain2.peers.peer3.tls.cacrt
            volumeMounts:
              - name: fabricfiles
                mountPath: /fabric
              - name: peer3file
                mountPath: /var/hyperledger/production/
              - name: secret-volume
                mountPath: /etc/secret-volume
            ports:
              - containerPort: 7051
- apiVersion: v1
  kind: Service
  metadata:
    annotations: null
    labels: null
    name: peer3
  spec:
    ports:
    - name: "7051"
      port: 7051
      targetPort: 7051
    selector:
      name: peer3
- kind: PersistentVolumeClaim
  apiVersion: v1
  metadata:
    name: peer3-pvc
  spec:
    accessModes:
      #- ReadWriteOnce #CONFIG1 -> KO
      - ReadWriteMany #CONFIG2 -> OK
    resources:
      requests:
        storage: 1Gi
    #storageClassName: ibmc-block-retain-bronze #CONFIG1 -> KO
    storageClassName: ibmc-file-bronze #CONFIG2 -> OK

